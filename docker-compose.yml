# Auth Service - Independent Infrastructure
# This docker-compose file provides completely independent infrastructure for Auth Service
# Can be used in ANY project without dependencies on other services

version: '3.8'

services:
  # PostgreSQL Database - Dedicated for Auth Service
  auth-postgres:
    image: postgres:16-alpine
    container_name: auth-service-postgres
    environment:
      POSTGRES_DB: auth_service
      POSTGRES_USER: gravity
      POSTGRES_PASSWORD: gravity_secret_2025
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"
    ports:
      - "5432:5432"
    volumes:
      - auth_postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U gravity -d auth_service" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - auth-network
    restart: unless-stopped

  # Redis - Dedicated for Auth Service (Token Blacklist, Sessions)
  auth-redis:
    image: redis:7-alpine
    container_name: auth-service-redis
    command: redis-server --requirepass redis_secret_2025 --maxmemory 256mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - auth_redis_data:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "--raw", "incr", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - auth-network
    restart: unless-stopped

  # Auth Service Application
  auth-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: auth-service-app
    environment:
      # Application
      APP_NAME: auth-service
      APP_ENV: development
      DEBUG: "true"
      LOG_LEVEL: INFO

      # Database
      DATABASE_URL: postgresql+asyncpg://gravity:gravity_secret_2025@auth-postgres:5432/auth_service
      DATABASE_POOL_SIZE: 20
      DATABASE_MAX_OVERFLOW: 10
      DATABASE_ECHO: "false"

      # Redis
      REDIS_URL: redis://:redis_secret_2025@auth-redis:6379/0
      REDIS_MAX_CONNECTIONS: 50

      # Security & JWT
      SECRET_KEY: auth-service-super-secret-key-change-this-in-production-2025
      JWT_SECRET_KEY: jwt-super-secret-key-change-this-in-production-2025
      JWT_ALGORITHM: HS256
      ACCESS_TOKEN_EXPIRE_MINUTES: 30
      REFRESH_TOKEN_EXPIRE_DAYS: 7

      # CORS
      CORS_ORIGINS: http://localhost:3000,http://localhost:8080,http://localhost:5173
      CORS_CREDENTIALS: "true"

      # API Settings
      API_V1_PREFIX: /api/v1/auth
      API_TITLE: Gravity Auth Service
      API_DESCRIPTION: Independent Authentication & Authorization Microservice
      API_VERSION: 1.0.0

      # Rate Limiting
      RATE_LIMIT_ENABLED: "true"
      RATE_LIMIT_PER_MINUTE: 60

      # Monitoring
      PROMETHEUS_ENABLED: "true"
    ports:
      - "8001:8001"
    depends_on:
      auth-postgres:
        condition: service_healthy
      auth-redis:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8001/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - auth-network
    restart: unless-stopped
    volumes:
      - ./app:/app/app:ro # Mount source code (read-only for production)
    # For development, uncomment below and comment above
    # volumes:
    #   - ./app:/app/app
    #   - ./tests:/app/tests

    # Volumes for data persistence
volumes:
  auth_postgres_data:
    driver: local
    name: auth_service_postgres_data
  auth_redis_data:
    driver: local
    name: auth_service_redis_data

# Isolated network for Auth Service
networks:
  auth-network:
    driver: bridge
    name: auth_service_network
